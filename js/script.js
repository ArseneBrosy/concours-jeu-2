/**
 * 2nd Game Jam with Alex
 * @author Ars√®ne Brosy
 * @since 09.11.2024
 */

const canvas = document.querySelector("#game");
const ctx = canvas.getContext("2d");

//region Constants
const DEBUG_MODE = false;
const GROUND_FRICTION = 3;
const GROUND_DECELERATION = 0.01;
const BACK_TO_TRACK_TIME = 1500;

const CAR_SPRITE = new Image();
CAR_SPRITE.src = "images/car.png";

let TRACK = JSON.parse('[[1069,1754],[1114,1706],[1161,1658],[1207,1610],[1254,1562],[1300,1515],[1347,1467],[1393,1419],[1440,1371],[1486,1324],[1533,1276],[1579,1228],[1626,1180],[1672,1132],[1719,1085],[1765,1037],[1812,989],[1858,941],[1905,894],[1952,846],[2001,801],[2051,757],[2100,712],[2150,668],[2199,623],[2249,578],[2298,534],[2348,489],[2397,444],[2447,400],[2496,355],[2546,310],[2595,266],[2645,221],[2694,176],[2744,132],[2800,97],[2861,70],[2922,43],[2983,56],[3045,82],[3106,107],[3158,148],[3207,193],[3256,239],[3304,284],[3353,330],[3402,375],[3451,420],[3508,455],[3565,490],[3621,525],[3678,559],[3735,594],[3792,629],[3849,663],[3906,698],[3963,733],[4020,767],[4077,802],[4134,837],[4191,871],[4248,906],[4305,941],[4362,976],[4418,1010],[4475,1045],[4532,1080],[4589,1114],[4646,1149],[4703,1184],[4760,1218],[4817,1253],[4874,1288],[4931,1323],[4988,1357],[5045,1392],[5102,1427],[5159,1461],[5215,1496],[5272,1531],[5329,1565],[5386,1600],[5443,1635],[5500,1670],[5557,1704],[5618,1731],[5679,1758],[5740,1785],[5801,1812],[5862,1839],[5923,1866],[5984,1893],[6045,1920],[6106,1947],[6164,1978],[6220,2015],[6275,2053],[6330,2090],[6385,2128],[6440,2165],[6496,2202],[6551,2240],[6606,2277],[6661,2314],[6716,2352],[6772,2389],[6827,2427],[6882,2464],[6937,2501],[6992,2539],[7049,2572],[7114,2587],[7179,2601],[7245,2615],[7310,2624],[7375,2611],[7441,2599],[7506,2586],[7572,2574],[7623,2537],[7668,2488],[7714,2438],[7759,2389],[7804,2340],[7837,2284],[7864,2223],[7891,2162],[7917,2100],[7921,2034],[7926,1967],[7930,1901],[7935,1834],[7940,1768],[7944,1701],[7949,1635],[7955,1569],[7985,1509],[8014,1449],[8044,1390],[8098,1354],[8157,1323],[8216,1292],[8275,1261],[8340,1246],[8405,1235],[8471,1224],[8537,1212],[8602,1201],[8668,1190],[8734,1179],[8800,1168],[8865,1157],[8931,1145],[8997,1134],[9062,1123],[9128,1112],[9194,1101],[9260,1089],[9325,1078],[9391,1067],[9457,1056],[9522,1045],[9588,1033],[9654,1022],[9720,1011],[9785,1000],[9851,989],[9917,977],[9983,966],[10048,955],[10113,947],[10169,983],[10226,1019],[10219,1083],[10207,1148],[10196,1214],[10150,1262],[10104,1310],[10057,1358],[10011,1406],[9965,1454],[9918,1502],[9884,1559],[9851,1617],[9818,1675],[9785,1733],[9752,1791],[9719,1849],[9686,1907],[9656,1966],[9641,2031],[9638,2096],[9653,2161],[9688,2212],[9741,2253],[9802,2270],[9867,2266],[9915,2219],[9959,2170],[9996,2114],[10033,2059],[10070,2003],[10107,1948],[10144,1893],[10181,1837],[10219,1782],[10267,1736],[10328,1726],[10388,1748],[10444,1785],[10499,1822],[10555,1859],[10610,1896],[10666,1933],[10721,1970],[10756,2024],[10768,2086],[10743,2148],[10699,2194],[10643,2230],[10587,2266],[10530,2301],[10474,2337],[10418,2373],[10361,2408],[10305,2444],[10249,2480],[10193,2516],[10136,2551],[10080,2587],[10024,2623],[9967,2658],[9911,2694],[9855,2730],[9799,2766],[9742,2801],[9686,2837],[9630,2873],[9573,2908],[9517,2944],[9461,2980],[9404,3016],[9348,3051],[9292,3087],[9236,3123],[9179,3158],[9123,3194],[9067,3230],[9005,3254],[8941,3271],[8877,3288],[8812,3305],[8748,3322],[8683,3339],[8617,3340],[8550,3339],[8483,3338],[8417,3337],[8350,3336],[8283,3335],[8217,3334],[8150,3333],[8083,3332],[8017,3331],[7950,3330],[7883,3329],[7817,3327],[7750,3326],[7683,3325],[7617,3324],[7552,3311],[7490,3288],[7427,3265],[7364,3242],[7302,3220],[7239,3197],[7176,3174],[7114,3151],[7051,3129],[6988,3106],[6927,3080],[6869,3049],[6810,3017],[6751,2985],[6693,2953],[6634,2921],[6576,2889],[6517,2857],[6459,2825],[6400,2793],[6342,2762],[6283,2729],[6227,2694],[6170,2658],[6114,2623],[6057,2588],[6001,2552],[5944,2517],[5888,2482],[5831,2446],[5775,2411],[5718,2376],[5664,2337],[5614,2293],[5565,2248],[5502,2227],[5437,2215],[5371,2213],[5306,2221],[5247,2251],[5203,2300],[5148,2335],[5086,2361],[5020,2366],[4953,2371],[4888,2357],[4827,2331],[4772,2295],[4732,2242],[4709,2180],[4701,2114],[4694,2048],[4682,1982],[4640,1931],[4590,1887],[4537,1846],[4484,1806],[4432,1765],[4379,1725],[4326,1684],[4273,1644],[4220,1603],[4167,1563],[4114,1522],[4061,1482],[4008,1441],[3955,1401],[3902,1360],[3849,1319],[3796,1279],[3743,1238],[3691,1198],[3638,1157],[3585,1117],[3532,1076],[3479,1036],[3426,995],[3373,955],[3320,914],[3267,874],[3207,844],[3146,821],[3079,817],[3013,816],[2947,826],[2883,842],[2824,874],[2770,912],[2717,953],[2665,995],[2613,1036],[2561,1077],[2508,1119],[2456,1160],[2404,1202],[2390,1216],[2342,1262],[2294,1309],[2246,1355],[2199,1402],[2151,1448],[2112,1502],[2089,1564],[2085,1629],[2095,1695],[2114,1758],[2117,1824],[2105,1890],[2082,1952],[2049,2009],[2006,2060],[1962,2111],[1919,2162],[1876,2213],[1833,2263],[1790,2314],[1746,2365],[1703,2416],[1660,2467],[1617,2517],[1574,2568],[1512,2579],[1445,2579],[1379,2579],[1314,2563],[1250,2544],[1193,2568],[1138,2606],[1084,2644],[1055,2702],[1034,2765],[1013,2828],[992,2892],[971,2955],[962,3020],[962,3087],[962,3153],[962,3220],[962,3287],[962,3353],[962,3420],[962,3487],[962,3553],[962,3620],[962,3687],[962,3753],[962,3820],[962,3887],[977,3950],[1004,4011],[1030,4073],[1056,4134],[1083,4195],[1109,4256],[1128,4319],[1134,4386],[1140,4452],[1128,4513],[1084,4563],[1027,4588],[960,4588],[893,4587],[840,4549],[787,4508],[735,4467],[682,4426],[630,4384],[577,4343],[525,4302],[472,4261],[419,4221],[367,4180],[314,4139],[261,4098],[209,4057],[156,4016],[103,3975],[69,3920],[40,3860],[58,3798],[83,3736],[128,3689],[178,3645],[229,3601],[255,3541],[279,3478],[303,3416],[327,3354],[339,3289],[346,3223],[353,3156],[360,3090],[368,3024],[375,2957],[382,2891],[411,2831],[440,2771],[469,2711],[498,2651],[527,2591],[555,2531],[584,2471],[613,2410],[641,2350],[679,2295],[718,2241],[756,2187],[795,2132],[834,2078],[873,2024],[912,1970],[951,1916],[991,1862],[1030,1808]]');
const TRACK_WIDTH = 250;
const MINI_TRACK_SIZE = 400;
const MINI_TRACK_MARGIN_X = 10;
const MINI_TRACK_MARGIN_Y = -200;

const TRACK_LAPS = 3;
for (let i = 0; i < TRACK_LAPS - 1; i++) {
  document.querySelector("#ends").innerHTML += "<div></div>";
}

const playback = JSON.parse('[{"x":1069,"y":1754,"r":43.15238973400541},{"x":1091.7799999999997,"y":1731.2200000000003,"r":42.3323897340054},{"x":1155.4599999999998,"y":1667.5400000000002,"r":42.3323897340054},{"x":1276.0502915748687,"y":1546.94,"r":42.3323897340054},{"x":1407.3692439413328,"y":1404.455676991187,"r":42.3323897340054},{"x":1566.9722783559585,"y":1229.2533042742457,"r":42.3323897340054},{"x":1723.237906730386,"y":1076.1326720172428,"r":48.352389734005406},{"x":1909.3021953379578,"y":910.6603767380628,"r":48.352389734005406},{"x":2084.5724377118186,"y":746.8010288895648,"r":45.532389734005406},{"x":2255.847613175234,"y":578.6796017305796,"r":45.532389734005406},{"x":2420.7876192930357,"y":416.9527765749559,"r":46.252389734005405},{"x":2594.271896805495,"y":259.92437571165954,"r":47.93238973400541},{"x":2811.081034916991,"y":117.74258882687973,"r":114.35238973400544},{"x":3027.541979385413,"y":45.06570011136376,"r":243.9823897340054},{"x":3155.9994653665576,"y":52.49204703955751,"r":215.60238973400527},{"x":3226.6882596502483,"y":132.50704109649325,"r":150.35238973400516},{"x":3344.2509788415728,"y":253.53676374947784,"r":117.352389734005},{"x":3516.4397868198657,"y":377.9574604992235,"r":126.17238973400501},{"x":3716.3692177858197,"y":505.2072915292047,"r":120.772389734005},{"x":3925.156408354328,"y":629.5331096625066,"r":120.772389734005},{"x":4115.900261466295,"y":743.1147212904611,"r":120.772389734005},{"x":4293.756016394993,"y":849.0218997003107,"r":120.772389734005},{"x":4482.704850587347,"y":970.7018797629482,"r":125.592389734005},{"x":4678.4933053753775,"y":1099.0432725508508,"r":118.922389734005},{"x":4888.55945074145,"y":1215.1131419012818,"r":118.922389734005},{"x":5098.625089497213,"y":1331.1839277497727,"r":118.94238973400499},{"x":5301.8452698950405,"y":1447.188272127225,"r":120.30238973400499},{"x":5503.550372673245,"y":1577.1998058295662,"r":123.01238973400498},{"x":5697.803080491782,"y":1696.8118696317613,"r":116.99238973400499},{"x":5911.659116632423,"y":1805.7411852736147,"r":116.99238973400499},{"x":6122.841952321307,"y":1913.308884469945,"r":116.99238973400499},{"x":6324.832369124425,"y":2030.908119249155,"r":121.81238973400498},{"x":6515.734649993253,"y":2164.856348742729,"r":129.16238973400502},{"x":6694.84262525577,"y":2310.7375785063955,"r":129.16238973400502},{"x":6892.951964238886,"y":2440.512294532465,"r":109.89238973400502},{"x":7153.403726210841,"y":2516.209876272106,"r":94.89238973400501},{"x":7407.53466583356,"y":2514.1058541328825,"r":75.622389734005},{"x":7647.499926019188,"y":2443.8946222561626,"r":49.252389734004986},{"x":7832.142678889256,"y":2298.2116504542164,"r":24.17238973400499},{"x":7939.345431759325,"y":2076.005681650776,"r":-18.797610265995022},{"x":7977.608919976359,"y":1829.8120084231964,"r":10.602389734004985},{"x":8050.576841100241,"y":1581.8130046115782,"r":31.02238973400499},{"x":8186.14140729147,"y":1392.3241477616407,"r":80.49238973400502},{"x":8406.425331984497,"y":1262.1107382211344,"r":91.02238973400502},{"x":8666.06179221301,"y":1206.686228609868,"r":82.20238973400501},{"x":8915.731674246677,"y":1172.4963177395425,"r":82.20238973400501},{"x":9163.439207349837,"y":1128.188737049681,"r":76.802389734005},{"x":9376.655072698717,"y":1078.1887894141923,"r":76.802389734005},{"x":9578.18787693259,"y":1030.9285649368126,"r":76.802389734005},{"x":9782.745477296708,"y":983.4356827954915,"r":78.62238973400501},{"x":9984.018419014734,"y":966.3578594952784,"r":146.52238973400506},{"x":10145.069419781108,"y":997.5120983864878,"r":278.052389734005},{"x":10265.34861509837,"y":1006.2066482348097,"r":319.8723897340048},{"x":10318.61962987072,"y":960.9814485546887,"r":251.5023897340047},{"x":10302.392464098159,"y":964.8684402673557,"r":213.67238973400458},{"x":10219.919839960332,"y":1035.4416108474272,"r":212.95238973400458},{"x":10116.131730600116,"y":1163.3596865840386,"r":205.60238973400462},{"x":10013.718493637267,"y":1355.3645171522319,"r":205.60238973400462},{"x":9908.457550857107,"y":1567.1916186390515,"r":212.67238973400458},{"x":9784.556174543486,"y":1754.5060148658324,"r":213.67238973400458},{"x":9680.823567961343,"y":1940.4510949916234,"r":182.87238973400457},{"x":9624.097315693733,"y":2129.661187805376,"r":62.76238973400454},{"x":9611.49287631972,"y":2289.260194113774,"r":-4.327610265995377},{"x":9602.91810356124,"y":2364.5697213208655,"r":6.582459626542513},{"x":9621.367809926733,"y":2379.279987697467,"r":20.110572392588992},{"x":9650.455883938994,"y":2369.1568898627024,"r":28.178176323252945},{"x":9684.086909417036,"y":2345.098858717341,"r":33.518403539386625},{"x":9738.333049564757,"y":2290.8210009524687,"r":41.77154761766681},{"x":9818.045820851425,"y":2204.5192574742,"r":42.70781174436475},{"x":9955.080955397494,"y":2056.0563235501586,"r":42.70781174436475},{"x":10108.282487439452,"y":1903.9178147558564,"r":60.76781174436476},{"x":10301.271185822872,"y":1794.8617638490246,"r":175.25781174436477},{"x":10461.854948983773,"y":1739.190791271553,"r":246.03781174436472},{"x":10559.801179755936,"y":1743.4672795294014,"r":197.68781174436464},{"x":10600.80854143178,"y":1814.12265486363,"r":178.06781174436458},{"x":10614.037819590636,"y":1955.7692997801998,"r":173.7978117443646},{"x":10618.520231731358,"y":2156.709505933761,"r":223.03438304787133},{"x":10558.510363781636,"y":2334.419946696883,"r":347.5743830478714},{"x":10511.608266933581,"y":2448.458299577613,"r":346.7443830478712},{"x":10453.557301564413,"y":2490.1030972228664,"r":286.51258313304595},{"x":10327.05422410655,"y":2474.313575243508,"r":273.4425831330459},{"x":10124.962036703198,"y":2491.203229529628,"r":235.04258313304584},{"x":9911.052150221163,"y":2583.154777870723,"r":235.04258313304584},{"x":9704.518466721267,"y":2724.9668551194277,"r":235.04258313304584},{"x":9488.149845911852,"y":2876.230267513192,"r":235.04258313304584},{"x":9288.992365394095,"y":3015.4613630119975,"r":235.04258313304584},{"x":9118.78701793001,"y":3122.3850022775787,"r":240.44258313304593},{"x":8928.93820904373,"y":3221.4451013022235,"r":255.89258313304595},{"x":8729.750197548676,"y":3275.0127023207615,"r":263.26258313304595},{"x":8508.616108019234,"y":3288.5543964792214,"r":274.53258313304593},{"x":8299.272871640607,"y":3272.2565015986047,"r":274.53258313304593},{"x":8086.786843542539,"y":3260.021371107998,"r":264.88258313304584},{"x":7880.871061141439,"y":3278.3070909341272,"r":264.11258313304586},{"x":7676.269668481962,"y":3285.8831267934315,"r":288.38258313304596},{"x":7483.883031123611,"y":3248.1982664814705,"r":289.4625831330459},{"x":7280.225426251594,"y":3176.783196828565,"r":289.4625831330459},{"x":7076.567821379578,"y":3104.8138979728396,"r":289.4625831330459},{"x":6898.783397620046,"y":3032.6136195098265,"r":293.2125831330458},{"x":6708.54029587312,"y":2951.025861618636,"r":293.2125831330458},{"x":6512.782901321935,"y":2867.073241179875,"r":293.2125831330458},{"x":6300.482628357974,"y":2776.0260330984015,"r":293.2125831330458},{"x":6113.666197113709,"y":2694.3324290801042,"r":297.4125831330458},{"x":5936.046930466375,"y":2589.592498015255,"r":308.00258313304585},{"x":5787.031959265255,"y":2449.983034081532,"r":315.7825831330459},{"x":5618.223490904186,"y":2321.841048185103,"r":261.8825831330459},{"x":5440.8425509475255,"y":2242.59521007124,"r":189.23258313304584},{"x":5309.081584134961,"y":2212.2052051541245,"r":207.9225831330458},{"x":5200.127228151579,"y":2233.002283638635,"r":216.7825831330458},{"x":5065.866867496002,"y":2288.6818625329065,"r":289.58258313304583},{"x":4900.449978719395,"y":2316.626440607658,"r":415.3825831330459},{"x":4797.845265983129,"y":2288.3693522889157,"r":419.7625831330457},{"x":4749.852729287207,"y":2212.67059757668,"r":381.12258313304557},{"x":4733.66949015891,"y":2091.4889262660713,"r":326.03258313304536},{"x":4678.323594372482,"y":1931.2431055168054,"r":318.76258313304544},{"x":4573.525584154367,"y":1773.8019505938566,"r":316.3625831330454},{"x":4418.432630675508,"y":1631.282847091929,"r":308.29258313304535},{"x":4252.701657069466,"y":1526.995261281735,"r":300.2725831330453},{"x":4070.6675190854507,"y":1417.052837807794,"r":307.0825831330454},{"x":3905.830898396723,"y":1287.5503058545557,"r":308.34258313304537},{"x":3745.830531456824,"y":1160.9964336139176,"r":308.34258313304537},{"x":3583.463107001109,"y":1037.5533370534242,"r":304.0725831330453},{"x":3386.1691313783767,"y":915.1350248386734,"r":286.0125831330453},{"x":3168.7349772366406,"y":843.0050887950711,"r":203.75258313304533},{"x":3008.777762271954,"y":833.56211558636,"r":202.6725831330453},{"x":2882.626299147365,"y":895.937882221887,"r":240.44258313304528},{"x":2697.18234707748,"y":967.0057292190874,"r":255.65258313304528},{"x":2495.162918912687,"y":1053.06702662462,"r":208.5225831330452},{"x":2338.745141928286,"y":1214.9089733339672,"r":216.59258313304517},{"x":2184.9459377950134,"y":1421.5877843251524,"r":216.59258313304517},{"x":2001.1804219984801,"y":1604.2561007765219,"r":251.8525831330452},{"x":1827.4027045519401,"y":1716.2795076740108,"r":194.13792733549954},{"x":1771.4899506138033,"y":1787.2480624568777,"r":143.18780499647758},{"x":1742.7121889551624,"y":1841.707341027145,"r":108.98333690481589},{"x":1732.990847223307,"y":1872.942682186409,"r":89.6033369048159},{"x":1737.991463037423,"y":1891.4730032460207,"r":75.2700035714826},{"x":1758.076100078553,"y":1893.9108343554587,"r":48.74000357148261},{"x":1796.3395906302153,"y":1879.8505931596308,"r":56.13000357148265},{"x":1845.7246862671318,"y":1856.2313086599802,"r":69.38000357148269},{"x":1912.467675555624,"y":1837.4273837512567,"r":87.34667023814937},{"x":1973.0540825079777,"y":1834.2249748936204,"r":127.67333690481622},{"x":2027.2415307952808,"y":1847.2237601179245,"r":169.84858691219432},{"x":2075.3819273179433,"y":1886.1636346685507,"r":218.47861202514088},{"x":2116.19042189596,"y":1986.5082613803181,"r":220.8689824905457},{"x":2122.739402536383,"y":2160.5791030943665,"r":221.75666850494457},{"x":2094.6592835344813,"y":2249.802436458528,"r":255.6191864956599},{"x":2053.6479555087526,"y":2288.019457230875,"r":259.1274042198169},{"x":2001.219142717398,"y":2304.8310334609378,"r":255.43277310945095},{"x":1934.4402025253576,"y":2326.9830036540166,"r":251.97277310945097},{"x":1854.5430835899047,"y":2356.043373791344,"r":246.08182469534165},{"x":1735.971968733429,"y":2408.643330819009,"r":246.07719506571203},{"x":1533.0222335043716,"y":2495.423145076856,"r":252.887195065712},{"x":1310.5725647779773,"y":2565.6266113617435,"r":241.547195065712},{"x":1129.0062581057862,"y":2688.004966406292,"r":181.54719506571195},{"x":1005.2024784331804,"y":2890.941698079181,"r":177.27719506571196},{"x":955.2141199271723,"y":3147.7467915346415,"r":162.51719506571197},{"x":977.5066732615257,"y":3404.9465337206775,"r":176.257195065712},{"x":982.8699399052396,"y":3653.638437914811,"r":182.277195065712},{"x":998.6076886939641,"y":3904.015387074248,"r":140.00719506571198},{"x":1086.810537575416,"y":4124.271828434528,"r":176.74719506571194},{"x":1135.9791344233324,"y":4315.7088791704455,"r":245.59719506571196},{"x":1132.4935256281346,"y":4459.800292426805,"r":295.29719506571195},{"x":1077.6742252976073,"y":4546.575161902501,"r":331.99719506571194},{"x":977.4023056574244,"y":4583.366575158861,"r":331.99719506571194},{"x":877.3956559792008,"y":4567.191444634558,"r":331.99719506571194},{"x":756.6934772309093,"y":4484.372489232907,"r":326.597195065712},{"x":617.2267655952319,"y":4334.912845378911,"r":317.62719506571204},{"x":445.98426251762953,"y":4150.582741446818,"r":316.9971950657121},{"x":301.2684723065555,"y":3961.5650128546117,"r":357.07032975529694},{"x":238.49733119056907,"y":3811.257965930074,"r":419.1490758294971},{"x":229.2150705398562,"y":3735.6660306612193,"r":409.50218735933686},{"x":264.6007367634222,"y":3625.5173499724533,"r":397.94125672732577},{"x":379.6824258834317,"y":3413.3772527295137,"r":387.0552254831482},{"x":460.3236482841656,"y":3178.8881606463783,"r":322.50522548314814},{"x":474.01571899030506,"y":2966.074949812469,"r":371.91522548314816},{"x":507.16717923688276,"y":2755.6584343405993,"r":396.79522548314816},{"x":575.035794826054,"y":2531.182990511042,"r":379.5652254831482},{"x":680.4566685806983,"y":2302.71823791449,"r":388.5152254831482},{"x":824.804393674983,"y":2083.4016014357458,"r":397.3352254831482},{"x":984.9310486614912,"y":1873.5077217915707,"r":397.53522548314817},{"x":1136.2224520159227,"y":1695.0263081142577,"r":400.6052254831483},{"x":1306.3343631723487,"y":1517.6595500809929,"r":406.0052254831482},{"x":1468.2000722599273,"y":1361.3761785356762,"r":406.0052254831482},{"x":1619.2747340750007,"y":1215.511698426714,"r":406.0052254831482},{"x":1768.191186435573,"y":1071.7309966050227,"r":406.0052254831482},{"x":1934.3733144321536,"y":911.280068485158,"r":406.0052254831482},{"x":2107.0300707922374,"y":744.5778055034779,"r":406.0052254831482},{"x":2275.370408243319,"y":582.0430990963397,"r":406.0052254831482},{"x":2475.8287714146813,"y":410.5260050660948,"r":412.02522548314823},{"x":2697.7087644810304,"y":245.56084934993515,"r":425.3452254831483},{"x":2944.9226952781887,"y":147.19200811878807,"r":555.6852254831483},{"x":3119.0523163722537,"y":131.63316688764104,"r":569.2052254831483},{"x":3230.5184251466044,"y":197.6953019337594,"r":506.9552254831482},{"x":3387.23622031745,"y":338.5503658116739,"r":500.28522548314817},{"x":3573.735831034529,"y":517.0290440904229,"r":478.68522548314814},{"x":3807.5817359443995,"y":648.3363326468047,"r":478.68522548314814},{"x":4026.0219576967133,"y":767.855659622855,"r":478.68522548314814},{"x":4257.028611719251,"y":895.5383118871621,"r":482.10522548314816},{"x":4467.892236489312,"y":1043.5373437194075,"r":485.35522548314816},{"x":4683.205418117982,"y":1196.2993606507653,"r":485.35522548314816},{"x":4888.077162083907,"y":1337.7513902867097,"r":482.9552254831482},{"x":5100.627377839469,"y":1473.2800645499517,"r":478.0452254831482},{"x":5337.161059830529,"y":1591.1136733453943,"r":476.84522548314817},{"x":5565.647449065941,"y":1718.736525044854,"r":469.7952254831482},{"x":5812.423917871046,"y":1806.7796895961135,"r":469.6752254831483},{"x":6052.170030012399,"y":1921.9970506545208,"r":477.02522548314835},{"x":6263.291184843953,"y":2029.6857593596756,"r":477.02522548314835},{"x":6437.7424324109425,"y":2129.312066852501,"r":480.7752254831483},{"x":6611.949198910861,"y":2241.028764111647,"r":483.59522548314834},{"x":6777.391484167528,"y":2364.921457095703,"r":488.99522548314826},{"x":6960.047242758423,"y":2498.0736925972124,"r":475.0252254831483},{"x":7168.645489209184,"y":2582.6111800694407,"r":449.21522548314823},{"x":7370.706717614456,"y":2613.1594106531497,"r":436.20522548314824},{"x":7550.628702107677,"y":2596.306118606968,"r":397.63522548314825},{"x":7691.970382105586,"y":2521.1724973561686,"r":370.96522548314823},{"x":7780.448467492821,"y":2373.784308215697,"r":376.36522548314815},{"x":7849.281975653213,"y":2158.150066159086,"r":373.21522548314806},{"x":7905.578487337943,"y":1915.598104786985,"r":372.37522548314803},{"x":7947.203594254845,"y":1662.1965436585524,"r":382.67522548314804},{"x":8044.6335435330375,"y":1458.783263067893,"r":423.71522548314806},{"x":8214.313492811229,"y":1325.315226171804,"r":447.6852254831479},{"x":8447.623222175875,"y":1245.258130099379,"r":432.175225483148},{"x":8680.076805661742,"y":1197.472271305867,"r":441.7752254831479},{"x":8902.762560528567,"y":1165.284469588329,"r":441.7752254831479},{"x":9161.072725768741,"y":1127.9103544637815,"r":441.4752254831479},{"x":9414.210412103239,"y":1066.2709286546424,"r":435.1052254831479},{"x":9657.743092730365,"y":1001.4956751499938,"r":435.1052254831479},{"x":9900.958114089983,"y":965.687628235332,"r":499.9052254831479},{"x":10089.552349019634,"y":999.982431900795,"r":620.5652254831481},{"x":10212.257873884668,"y":1050.6782612102902,"r":578.375225483148},{"x":10250.272154454757,"y":1176.2458101096768,"r":589.235225483148},{"x":10206.602656499572,"y":1328.541611666493,"r":599.3652254831479},{"x":10085.493158544386,"y":1439.8415406648082,"r":606.8952254831479},{"x":9905.226962767432,"y":1553.1099576755917,"r":593.825225483148},{"x":9731.034361181499,"y":1719.7264715599829,"r":547.455225483148},{"x":9632.30739632936,"y":1908.6844710269274,"r":493.7552254831481},{"x":9580.302734992005,"y":2080.59147068926,"r":403.22522548314805},{"x":9589.586532805959,"y":2197.4387041002856,"r":393.2152254831481},{"x":9660.536486256431,"y":2247.9482621997918,"r":402.92522548314804},{"x":9818.821189772478,"y":2229.981079982549,"r":402.92522548314804},{"x":9967.545828155275,"y":2139.895988705094,"r":393.32522548314813},{"x":10111.241299408652,"y":1980.1409172582507,"r":407.3852254831482},{"x":10308.717533427678,"y":1832.7755767921008,"r":530.8452254831482},{"x":10465.025677652431,"y":1758.9516858554134,"r":555.1252254831481},{"x":10548.840339228598,"y":1764.2579416249707,"r":563.3252254831484},{"x":10577.355000804768,"y":1857.9241973945277,"r":517.4552254831484},{"x":10679.343017045021,"y":2015.5173022498598,"r":492.3952254831484},{"x":10808.697678621189,"y":2226.148123603183,"r":629.8752254831486},{"x":10845.536588867028,"y":2353.2727720783937,"r":665.3449476896401},{"x":10826.666754085103,"y":2387.203104045896,"r":651.5043963147692},{"x":10782.864951600193,"y":2382.412305932819,"r":651.5043963147692},{"x":10712.086526789666,"y":2352.914993365911,"r":651.5043963147692},{"x":10629.350474792753,"y":2329.1780824510097,"r":628.829766429875},{"x":10504.002626527434,"y":2328.550565701497,"r":608.3323784356952},{"x":10309.323015014501,"y":2387.9578602708743,"r":604.4304890948412},{"x":10106.194800426603,"y":2506.2955429323806,"r":597.5004890948412},{"x":9914.11967671201,"y":2644.9918271082424,"r":593.7904890948413},{"x":9710.790386565004,"y":2793.858209372149,"r":593.7904890948413},{"x":9517.143443567857,"y":2935.635716290155,"r":593.7904890948413},{"x":9305.567015987948,"y":3072.5830416112503,"r":600.4804890948412},{"x":9099.789656936426,"y":3177.503446415307,"r":604.3804890948411},{"x":8871.48795968431,"y":3261.841794120707,"r":615.5704890948412},{"x":8642.844620890271,"y":3311.5407424189525,"r":621.5604890948409},{"x":8397.3732124642,"y":3315.9569249640126,"r":633.3104890948409},{"x":8154.756068074673,"y":3302.3852608156208,"r":631.490489094841},{"x":7912.16868132917,"y":3311.109436802028,"r":630.6404890948409},{"x":7678.185234974527,"y":3308.368040503482,"r":631.3604890948408},{"x":7449.88028017997,"y":3268.544732080867,"r":660.0404890948407},{"x":7231.721022390883,"y":3165.987921276388,"r":652.2304890948408},{"x":7009.155333042915,"y":3075.6538064254514,"r":651.9704890948408},{"x":6783.802800443019,"y":2984.740462790958,"r":651.9704890948408},{"x":6570.0461830924505,"y":2897.317940997517,"r":655.3904890948407},{"x":6355.227722304259,"y":2784.3577445175856,"r":657.9904890948408},{"x":6177.739594516543,"y":2690.0234215253045,"r":657.9904890948408},{"x":6002.755497500654,"y":2585.869919709101,"r":663.3904890948406},{"x":5832.427894642377,"y":2473.600120989475,"r":663.3904890948406},{"x":5658.713182848586,"y":2369.994974089418,"r":645.3304890948407},{"x":5431.612186093281,"y":2298.3753891904653,"r":594.1404890948409},{"x":5192.016461830678,"y":2297.254258031321,"r":612.2904890948407},{"x":4944.797143804112,"y":2341.873172796023,"r":660.5904890948407},{"x":4736.913384057736,"y":2322.3345430960867,"r":747.6604890948406},{"x":4612.322714637037,"y":2229.7240540568205,"r":735.4204890948406},{"x":4563.566918635095,"y":2091.5465781762646,"r":709.8336646923156},{"x":4531.852962647379,"y":1981.745234027553,"r":684.19058060738},{"x":4438.3742429204385,"y":1845.3770979346036,"r":678.8326223601009},{"x":4265.391908824322,"y":1689.458125095704,"r":669.3526223601009},{"x":4089.0890471456846,"y":1544.8853027399314,"r":669.3526223601009},{"x":3931.34438143319,"y":1415.5306722110822,"r":669.3526223601009},{"x":3775.9194902164672,"y":1288.0783156605985,"r":669.3526223601009},{"x":3611.2155010166566,"y":1153.016863196653,"r":669.3526223601009},{"x":3422.065010132429,"y":1013.4713877239282,"r":646.792622360101},{"x":3181.312140102756,"y":925.4512827019408,"r":616.282622360101},{"x":2951.510579296358,"y":904.2464254246603,"r":612.062622360101},{"x":2758.2448032144007,"y":942.7468158920867,"r":593.3226223601011},{"x":2569.978929198334,"y":1052.4998790402956,"r":587.4226223601011},{"x":2373.3696654143555,"y":1228.5529962028495,"r":587.4226223601011},{"x":2204.6271849460627,"y":1424.5794240348691,"r":536.8026223601012},{"x":2104.860915500964,"y":1668.749289425857,"r":519.1026223601011},{"x":2056.3922165805943,"y":1906.9453882368457,"r":583.022622360101},{"x":1943.860003555279,"y":2099.0266323053243,"r":583.022622360101},{"x":1775.9057159364088,"y":2286.6429020144424,"r":578.4026223601011},{"x":1609.0825380765077,"y":2485.5879303372003,"r":608.7326223601011},{"x":1399.8505117749962,"y":2614.0815217736804,"r":668.0926223601012},{"x":1164.5347470149345,"y":2678.8984918321958,"r":574.1326223601012},{"x":973.3107313403458,"y":2781.6763464280907,"r":480.0326223601013},{"x":850.517938457541,"y":2926.4765110895078,"r":489.1726223601012},{"x":815.7147917275076,"y":3044.054342932127,"r":477.910926749056},{"x":828.0951750898353,"y":3095.4486740747,"r":481.38809896547497},{"x":864.7433791514459,"y":3154.7758040169824,"r":496.1901702169429},{"x":936.4441125393215,"y":3254.7233382691707,"r":506.3635052768569},{"x":1023.3802021262496,"y":3431.994423685028,"r":520.5745699384714},{"x":1072.7707889729736,"y":3675.5941818859524,"r":537.1245699384714},{"x":1096.8297295530233,"y":3901.4148713609125,"r":522.2271798452545},{"x":1164.6783957611772,"y":4107.23218683388,"r":526.7159529139368},{"x":1199.8287661016911,"y":4340.0670794048565,"r":615.9259529139368},{"x":1159.1898771808135,"y":4514.65113777324,"r":698.2559529139368},{"x":1049.5169556484275,"y":4607.640373270864,"r":686.9859529139368},{"x":921.0510110449621,"y":4621.704785897728,"r":707.4059529139366},{"x":828.6521018124776,"y":4555.988844266112,"r":693.1859529139366},{"x":693.3679355717218,"y":4425.594319668417,"r":680.5459529139365},{"x":528.5130176284765,"y":4252.970649440999,"r":669.2759529139365},{"x":331.99829073436183,"y":4090.5308031910204,"r":673.0759529139365},{"x":177.45571176721717,"y":3876.8819676279522,"r":771.0359529139364},{"x":99.92196712999136,"y":3693.813872675879,"r":786.8759529139363},{"x":101.5982224927656,"y":3579.3381533253423,"r":785.7759529139364},{"x":174.541471876027,"y":3442.31200531714,"r":761.5259529139364},{"x":316.55889290888257,"y":3236.6768989803713,"r":736.0259529139364},{"x":409.9798109519816,"y":2987.7254489989964,"r":733.6259529139365},{"x":504.3818946651619,"y":2777.9747787200877,"r":762.0159529139365},{"x":621.1350748093549,"y":2577.9595624324156,"r":745.9859529139367},{"x":722.6269803684584,"y":2360.4708593681453,"r":744.9859529139367},{"x":828.2233821873912,"y":2141.700209680944,"r":748.2559529139367},{"x":952.694273502497,"y":1929.857290286742,"r":753.0759529139366},{"x":1084.4789281661335,"y":1729.317411727015,"r":756.1359529139365},{"x":1238.1240974799869,"y":1553.7428496570305,"r":763.7159529139365},{"x":1414.446525802248,"y":1386.5564137200042,"r":766.7159529139365},{"x":1593.525591684446,"y":1217.8949535023282,"r":766.7159529139365},{"x":1768.2368754719562,"y":1053.3471874363029,"r":766.7159529139365},{"x":1938.903481439362,"y":893.2631030477,"r":768.5359529139364},{"x":2104.7463964394688,"y":764.2869750450508,"r":770.6359529139365},{"x":2252.0519478511,"y":636.5328293806466,"r":768.9859529139367},{"x":2403.7134889020917,"y":504.624617927185,"r":768.9259529139367},{"x":2546.568419428837,"y":367.56360188488685,"r":765.7159529139367},{"x":2717.104571599104,"y":215.82136904628064,"r":785.5159529139366},{"x":2927.31957968989,"y":111.90444015487746,"r":877.2359529139367},{"x":3097.4254112823937,"y":69.72968212119812,"r":872.7659529139369},{"x":3207.611044632677,"y":99.93573241388347,"r":880.9159529139367},{"x":3313.1695328737383,"y":195.8879951961158,"r":862.8459529139369},{"x":3485.068404698728,"y":370.9441767916221,"r":857.255952913937},{"x":3657.871944103194,"y":554.3006983044545,"r":851.255952913937},{"x":3879.2265916955344,"y":695.5109640167611,"r":837.0859529139373},{"x":4112.513331069719,"y":812.5505593605882,"r":836.6359529139373},{"x":4345.709628685853,"y":929.7673762125911,"r":837.7359529139372},{"x":4567.551680383566,"y":1061.307340614941,"r":840.9059529139372},{"x":4791.492693683349,"y":1195.3648751374706,"r":840.9059529139372},{"x":5023.155810890021,"y":1334.0450832642252,"r":840.9059529139372},{"x":5239.3747202829145,"y":1463.4799441825296,"r":840.9059529139372},{"x":5471.878669858081,"y":1606.0401609829412,"r":846.5259529139372},{"x":5642.5879074614395,"y":1733.3303054261482,"r":844.5759529139373},{"x":5814.83400363121,"y":1848.1404598099443,"r":843.6359529139372},{"x":5993.907941024965,"y":1946.3132392687432,"r":836.9859529139372},{"x":6208.756863632157,"y":2046.5384516779707,"r":830.9659529139373},{"x":6436.685647909807,"y":2159.726426369039,"r":850.2359529139371},{"x":6638.524861044727,"y":2327.108593684607,"r":848.4159529139372},{"x":6854.4788868410615,"y":2463.5205787415753,"r":836.2159529139374},{"x":7088.812957115015,"y":2556.6774485896713,"r":822.6959529139376},{"x":7318.14805845003,"y":2590.8652918857897,"r":783.9959529139376},{"x":7540.766263499026,"y":2552.7797122975735,"r":765.8459529139377},{"x":7717.294514638795,"y":2440.7279162909836,"r":753.6959529139378},{"x":7842.334363101574,"y":2246.8923367027674,"r":728.3459529139379},{"x":7889.877990991769,"y":1993.1225887086594,"r":722.325952913938},{"x":7906.705164405417,"y":1733.7109978178735,"r":737.6259529139379},{"x":7964.372653327622,"y":1545.3901576523083,"r":759.5259529139378},{"x":8072.918963520144,"y":1396.5925982980714,"r":778.3859529139377},{"x":8250.277022604883,"y":1291.2348570356694,"r":799.9959529139376},{"x":8484.045573365143,"y":1246.375635228078,"r":807.3459529139374},{"x":8720.134067264393,"y":1229.21757022606,"r":801.3259529139374},{"x":8976.540070536697,"y":1181.9498648385,"r":796.5059529139374},{"x":9174.90848114398,"y":1134.3476204257988,"r":796.5059529139374},{"x":9387.862804295917,"y":1083.245210982752,"r":796.5059529139374},{"x":9591.565340468336,"y":1046.4045280154294,"r":803.8559529139372},{"x":9794.393555907776,"y":1024.5707234529516,"r":803.8559529139372},{"x":10003.30737397283,"y":1003.2855447068948,"r":807.6559529139372},{"x":10222.742675528481,"y":1021.7499872474917,"r":902.8559529139372},{"x":10381.61336566568,"y":1086.780728738524,"r":996.1256115503237},{"x":10439.2146137766,"y":1097.0878070409747,"r":990.0436488255896},{"x":10450.117507760548,"y":1098.9287193180169,"r":983.0951310239279},{"x":10435.248094275485,"y":1116.3146303533936,"r":972.4662188696062},{"x":10399.267474475877,"y":1143.8517383300773,"r":967.7728855362736},{"x":10338.52782368629,"y":1177.5384847361338,"r":965.286218869607},{"x":10258.507813137787,"y":1221.851771927512,"r":957.3638365453209},{"x":10162.694488046283,"y":1291.852341264616,"r":951.6667056959175},{"x":10011.796199482624,"y":1433.124860174119,"r":943.4769495996097},{"x":9876.582668132301,"y":1615.6504306306958,"r":900.4569495996097},{"x":9800.34159836209,"y":1822.5208047365766,"r":905.1169495996096},{"x":9763.78821412024,"y":2026.963215919319,"r":893.3569495996095},{"x":9769.69835995896,"y":2204.65993785662,"r":801.7269495996095},{"x":9816.797947728059,"y":2335.830107255097,"r":719.6069495996097},{"x":9844.799677060664,"y":2422.484566371554,"r":701.6953750858543},{"x":9835.614998271463,"y":2449.3425545468417,"r":705.4660693475768},{"x":9819.47737094206,"y":2449.476955885577,"r":720.6934766322338},{"x":9821.785656942124,"y":2433.690352884586,"r":737.4078240558963},{"x":9836.984376950364,"y":2406.696364668966,"r":742.697824055896},{"x":9863.938223750285,"y":2360.3524567897794,"r":742.697824055896},{"x":9897.615857138822,"y":2284.3129852712373,"r":742.697824055896},{"x":9948.08446697247,"y":2163.710389942432,"r":742.9353140898453},{"x":10026.410523333163,"y":2003.7841572419657,"r":750.5382778516265},{"x":10150.022565286847,"y":1851.4355806593296,"r":826.0182778516265},{"x":10290.35969277736,"y":1744.111583832832,"r":913.8882778516265},{"x":10388.555242857725,"y":1682.3959060308848,"r":941.1482778516265},{"x":10432.665359373144,"y":1673.2664889605246,"r":900.5482778516265},{"x":10457.71576493186,"y":1714.9962314024397,"r":879.4582778516267},{"x":10529.125881447279,"y":1805.266814332079,"r":857.2082778516267},{"x":10649.310194389507,"y":1951.6011365301315,"r":878.8282778516266},{"x":10736.172846918145,"y":2129.6649251264166,"r":987.8682778516268},{"x":10774.719079591277,"y":2277.513747632944,"r":1029.7782778516269},{"x":10765.498101332963,"y":2351.2864780139416,"r":1020.8616294196679},{"x":10728.421140848652,"y":2374.2533566306606,"r":1014.169351895808},{"x":10684.030388431594,"y":2368.7921600658074,"r":1006.2197292764757},{"x":10621.01555897104,"y":2353.471594947988,"r":991.3310138542128},{"x":10527.84909212563,"y":2355.23086544842,"r":968.7356916672646},{"x":10386.439555792025,"y":2398.3791404485532,"r":956.6377440985837},{"x":10207.330930528413,"y":2510.0335167213025,"r":951.2377440985838},{"x":10043.582653950987,"y":2641.511658791533,"r":951.2577440985838},{"x":9873.913337195796,"y":2755.0345839012057,"r":957.9077440985837},{"x":9685.836327473944,"y":2872.9796491396223,"r":957.9077440985837},{"x":9500.30089896455,"y":2989.3308621450874,"r":957.9077440985837},{"x":9319.84863288007,"y":3102.4943706846493,"r":957.9077440985837},{"x":9141.49496882343,"y":3213.364252853206,"r":960.6277440985837},{"x":8948.138133187893,"y":3290.0712545783335,"r":985.9277440985836},{"x":8750.638026380808,"y":3321.942352032244,"r":985.9277440985836},{"x":8547.153067852296,"y":3336.429299697646,"r":985.9277440985836},{"x":8349.65296104521,"y":3350.490160667007,"r":985.9277440985836},{"x":8158.1377059595525,"y":3364.1249349403265,"r":985.9277440985836},{"x":7972.562097955802,"y":3372.428450130922,"r":997.4777440985835},{"x":7771.55018226207,"y":3345.9765475442327,"r":999.9477440985835},{"x":7638.579810459199,"y":3322.655307812838,"r":999.9477440985835},{"x":7505.71358256033,"y":3298.756961676186,"r":1000.5477440985834},{"x":7364.671802099585,"y":3263.352919306748,"r":1011.8177440985834},{"x":7169.713939904088,"y":3186.4984488132486,"r":1011.8177440985834},{"x":6983.111414659827,"y":3111.7957208009775,"r":1011.8177440985834},{"x":6788.17548514216,"y":3033.693707445016,"r":1012.2377440985833},{"x":6598.438905782993,"y":2924.3899472448343,"r":1023.9677440985832},{"x":6421.524720822488,"y":2805.7764454405365,"r":1022.1477440985833},{"x":6246.358119907692,"y":2707.002298895648,"r":1019.1477440985833},{"x":6068.1913211708825,"y":2607.641381891637,"r":1019.1477440985833},{"x":5884.784322471226,"y":2505.3580849757436,"r":1019.1477440985833},{"x":5719.718023641535,"y":2413.3031177514395,"r":1019.1477440985833},{"x":5535.613794205449,"y":2300.8418516878464,"r":1023.5477440985833},{"x":5340.579508424573,"y":2208.9147181470303,"r":973.0877440985834},{"x":5149.696149976763,"y":2165.724777585685,"r":962.4677440985834},{"x":5013.54719319294,"y":2167.9033678330493,"r":984.1233136269964},{"x":4919.626745320959,"y":2169.0599245563876,"r":1025.5561939618049},{"x":4856.112035602245,"y":2151.719552631444,"r":1028.279562127728},{"x":4804.286839898597,"y":2120.377190699725,"r":1031.836228794395},{"x":4739.07365295625,"y":2065.1754197784644,"r":1030.8886141470286},{"x":4641.969895716065,"y":1977.0666281442618,"r":1033.1272731881425},{"x":4498.040320963866,"y":1848.4528200976742,"r":1030.7434315173844},{"x":4343.481799140476,"y":1715.3075485640252,"r":1030.7434315173844},{"x":4186.650357878507,"y":1580.2042583313519,"r":1030.7434315173844},{"x":4030.078942464035,"y":1449.5078731224694,"r":1027.4734315173844},{"x":3864.184071974579,"y":1325.7134765937335,"r":1026.4034315173847},{"x":3707.2367121915263,"y":1209.987393720712,"r":1026.4034315173847},{"x":3547.8006268312784,"y":1092.5823633194811,"r":1025.6834315173849},{"x":3357.5106098584565,"y":995.6878920498431,"r":988.0934315173847},{"x":3159.631131535858,"y":947.5537013478031,"r":987.8834315173849},{"x":2968.4532179133225,"y":942.4781224852189,"r":984.253431517385},{"x":2770.883473641274,"y":979.414494023699,"r":949.1834315173851},{"x":2639.8162162978933,"y":1045.3768034125474,"r":940.9034315173851},{"x":2633.8179395956104,"y":1049.7485039066976,"r":940.9034315173851},{"x":2506.534485823816,"y":1157.5224631574363,"r":948.973431517385},{"x":2344.0150184240833,"y":1304.1263764232588,"r":942.0734315173852},{"x":2206.397082773912,"y":1475.3249674078004,"r":920.9234315173853},{"x":2108.361894357987,"y":1716.5836444716463,"r":915.4934315173853},{"x":2002.9339882884735,"y":1927.9539168974843,"r":946.8734315173851},{"x":1843.601172789939,"y":2136.9188453298975,"r":934.7234315173853},{"x":1696.2206004320603,"y":2336.705732834572,"r":949.5434315173852},{"x":1483.7838295288057,"y":2485.2287242245256,"r":1002.9334315173851},{"x":1244.6487425059745,"y":2578.7291280906697,"r":909.733431517385},{"x":1067.6278751851562,"y":2734.264990544165,"r":884.273431517385},{"x":972.3766124543929,"y":2948.437615977499,"r":910.803431517385},{"x":944.8323458985832,"y":3207.1487450431814,"r":891.963431517385},{"x":958.0344229463891,"y":3461.318614568439,"r":892.8734315173851},{"x":987.90715283523,"y":3723.606159400782,"r":894.2234315173849},{"x":1039.414452453274,"y":3965.852726147147,"r":884.623431517385},{"x":1096.9792908826437,"y":4205.510889965349,"r":903.543431517385},{"x":1095.2752242064796,"y":4425.891032851512,"r":971.443431517385},{"x":1014.7209183140712,"y":4580.550573273436,"r":1046.3934315173851},{"x":895.4333825536967,"y":4654.210113695361,"r":1050.8234315173854},{"x":785.1200064138808,"y":4645.786532793328,"r":1066.843431517385},{"x":719.1256016199687,"y":4557.092633877231,"r":1054.243431517385},{"x":600.3799029584937,"y":4400.7729812534435,"r":1038.5734315173854},{"x":455.6303857792064,"y":4254.766489164779,"r":1032.6134315173863},{"x":289.9138405788813,"y":4120.990656738145,"r":1032.3934315173865},{"x":152.4671623977904,"y":3946.281581037083,"r":1113.7234315173862},{"x":69.78048421669943,"y":3780.678362857286,"r":1161.823431517386},{"x":41.90425586365764,"y":3657.037462418168,"r":1136.0734315173859},{"x":73.82172904865132,"y":3533.483057425236,"r":1145.1242620299788},{"x":129.95073251954787,"y":3483.862619619434,"r":1146.8225591163439},{"x":201.82703495591792,"y":3424.2779929148833,"r":1102.0227865677512},{"x":274.82192945264575,"y":3282.875605643956,"r":1083.6743000681536},{"x":361.48276672074763,"y":3045.799472553391,"r":1106.0796166732225},{"x":454.4292372468443,"y":2814.36009309482,"r":1098.8196166732225},{"x":531.7263906731581,"y":2590.2126750372636,"r":1094.3396166732227},{"x":604.012538032299,"y":2367.571403541256,"r":1106.4896166732226},{"x":710.784323176275,"y":2152.7677535446815,"r":1106.4896166732226},{"x":825.3444615207942,"y":1958.7227354485688,"r":1118.6396166732225},{"x":980.2867354182614,"y":1776.0079053518587,"r":1127.4496166732224}]');
//endregion

//region Global variables
let car = {
  x: TRACK[0][0],
  y: TRACK[0][1],
  rotation: 45,
  xVelocity: 0,
  yVelocity: 0,
  xTargetVelocity: 0,
  yTargetVelocity: 0,
  rVelocity: 0,
  direction: 0,
  groundFriction: 1,
  running: false,

  // constants
  max_rotation_speed: 2,
  rotation_acceleration : 0.02,
  rotation_friction: 0.03,
  acceleration: 0.01,
  max_speed: 3,
  width: 60,
  height: 120,
};

let camera = {
  speed: car.max_speed,
  target: {
    x: car.x,
    y: car.y
  },
  x: car.x,
  y: car.y,
  range_radius: canvas.clientHeight / 3
};

let isReturningToTrack = false;
let timeRemainingToTrack = BACK_TO_TRACK_TIME;
let timer = 0;
let startCountdown = 7;

let recorded = [];
//endregion

//region Functions
function pointToPoint(x1, y1, x2, y2) {
  return Math.sqrt((x1 - x2)**2 + (y1 - y2)**2);
}

function pointToLine(x, y, x1, y1, x2, y2) {

  let A = x - x1;
  let B = y - y1;
  let C = x2 - x1;
  let D = y2 - y1;

  let dot = A * C + B * D;
  let len_sq = C * C + D * D;
  let param = -1;
  if (len_sq !== 0) //in case of 0 length line
    param = dot / len_sq;

  let xx, yy;

  if (param < 0) {
    xx = x1;
    yy = y1;
  }
  else if (param > 1) {
    xx = x2;
    yy = y2;
  }
  else {
    xx = x1 + param * C;
    yy = y1 + param * D;
  }

  let dx = x - xx;
  let dy = y - yy;
  return Math.sqrt(dx * dx + dy * dy);
}

function distanceToTrack(x, y) {
  let minDistance = Infinity;
  for (let i = 0; i < TRACK.length; i++) {
    const nextIndex = (i + 1) % TRACK.length;
    const distance = pointToLine(x, y, TRACK[i][0], TRACK[i][1], TRACK[nextIndex][0], TRACK[nextIndex][1]);
    minDistance = Math.min(distance, minDistance);
  }
  return minDistance;
}

function timerToText(timer) {
  const minutes = Math.floor(timer / 60000);
  const seconds = Math.floor(timer / 1000) % 60;
  const millis = Math.floor(timer / 10) % 100;
  const minutesText = (minutes < 10 ? "0" : "") + minutes;
  const secondsText = (seconds < 10 ? "0" : "") + seconds;
  const millisText = (millis < 10 ? "0" : "") + millis;
  return `${minutesText}:${secondsText}.${millisText}`;
}

function returnToTrack(point) {
  const nextPoint = (point + 1) % TRACK.length;
  const xOffset = TRACK[nextPoint][0] - TRACK[point][0];
  const yOffset = TRACK[nextPoint][1] - TRACK[point][1];
  const dis = Math.sqrt(xOffset**2 + yOffset**2);
  const xAngle = xOffset / dis;
  const yAngle = yOffset / dis;
  let angle = Math.acos(xAngle) * (180/Math.PI);
  if (yAngle > 0) {
    angle = 360 - angle;
  }
  car.rotation = -angle + 90;
  car.x = TRACK[point][0];
  car.y = TRACK[point][1];
  camera.x = car.x;
  camera.y = car.y;
  car.rVelocity = 0;
  car.xVelocity = 0;
  car.yVelocity = 0;
  car.running = 0;
}
returnToTrack(0);
recorded.push({
  x: car.x,
  y: car.y,
  r: car.rotation
});
//endregion

//region Loop variables
let trackPos = 0;
let laps = 0;
let trackMinX = Infinity;
let trackMaxX = -Infinity;
let trackMinY = Infinity;
let trackMaxY = -Infinity;
for (let point of TRACK) {
  trackMinX = Math.min(trackMinX, point[0]);
  trackMaxX = Math.max(trackMaxX, point[0]);
  trackMinY = Math.min(trackMinY, point[1]);
  trackMaxY = Math.max(trackMaxY, point[1]);
}
const trackWidth = trackMaxX - trackMinX;
const trackHeight = trackMaxY - trackMinY;
const miniTrackMul = Math.max(trackWidth / MINI_TRACK_SIZE, trackHeight / MINI_TRACK_SIZE);
let camOffsetX, camOffsetY;
//endregion
setInterval(() => {
  canvas.width = canvas.clientWidth;
  canvas.height = canvas.clientHeight;

  //region Physics
  //region Track
  const trackDis = distanceToTrack(car.x, car.y);
  const onTrack = trackDis <= TRACK_WIDTH / 2;
  if (pointToPoint(car.x, car.y, TRACK[trackPos][0], TRACK[trackPos][1]) <= TRACK_WIDTH) {
    trackPos++;
    if (trackPos >= TRACK.length) {
      trackPos = 0;
      laps++;
    }
  }
  //endregion

  //region Car
  //region ground friction
  const gftarget = onTrack ? 1 : GROUND_FRICTION;
  if (Math.abs(car.groundFriction - gftarget) <= GROUND_DECELERATION) {
    car.groundFriction = gftarget;
  } else {
    car.groundFriction += GROUND_DECELERATION * (car.groundFriction < gftarget ? 1 : -1);
  }
  //endregion

  //region rotation
  car.rVelocity += car.rotation_acceleration * car.direction;
  car.rVelocity = Math.max(Math.min(car.rVelocity, car.max_rotation_speed), -car.max_rotation_speed);
  //endregion

  //region rotation friction
  if (car.direction === 0 || car.running === false) {
    if (Math.abs(car.rVelocity) <= car.rotation_friction) {
      car.rVelocity = 0;
    } else {
      car.rVelocity += car.rotation_friction * (car.rVelocity > 0 ? -1 : 1);
    }
  }
  car.rotation += car.rVelocity / car.groundFriction;
  //endregion

  //region speed
  //region target velocity
  car.xTargetVelocity = Math.sin(car.rotation * (Math.PI/180)) * car.max_speed * car.running;
  car.yTargetVelocity = Math.cos(car.rotation * (Math.PI/180)) * car.max_speed * car.running * -1;
  //endregion

  //region actual velocity
  if (Math.abs(car.xTargetVelocity - car.xVelocity) <= car.acceleration) {
    car.xVelocity = car.xTargetVelocity;
  } else {
    car.xVelocity += car.acceleration * (car.xTargetVelocity > car.xVelocity ? 1 : -1);
  }
  if (Math.abs(car.yTargetVelocity - car.yVelocity) <= car.acceleration) {
    car.yVelocity = car.yTargetVelocity;
  } else {
    car.yVelocity += car.acceleration * (car.yTargetVelocity > car.yVelocity ? 1 : -1);
  }
  //endregion

  //region move car
  car.x += car.xVelocity / car.groundFriction;
  car.y += car.yVelocity / car.groundFriction;
  //endregion
  //endregion
  //endregion
  //endregion

  //region Camera
  camera.target.x = car.x;
  camera.target.y = car.y;

  const camVelocityX = (camera.target.x - camera.x) / camera.range_radius * camera.speed;
  const camVelocityY = (camera.target.y - camera.y) / camera.range_radius * camera.speed;

  camera.x += camVelocityX;
  camera.y += camVelocityY;
  //endregion

  //region Draw
  //region Camera
  const camAdditionalX = camVelocityX * -camera.range_radius / camera.speed * 2;
  const camAdditionalY = camVelocityY * -camera.range_radius / camera.speed * 2;
  camOffsetX = -camera.x + camAdditionalX + canvas.clientWidth / 2;
  camOffsetY = -camera.y + camAdditionalY + canvas.height / 2;
  //endregion

  //region Track
  ctx.strokeStyle = "#4e5b5d";
  ctx.lineWidth  = TRACK_WIDTH;
  ctx.beginPath();
  ctx.moveTo(TRACK[0][0] + camOffsetX, TRACK[0][1] + camOffsetY);
  for (let point of TRACK) {
    ctx.lineTo(point[0] + camOffsetX, point[1] + camOffsetY);
  }
  ctx.closePath();
  ctx.stroke();
  //endregion

  //region Others
  const recordedIndex = Math.floor(timer / 500);
  const interpolation = (timer % 500) / 500;
  const recordX = playback[recordedIndex].x + (playback[recordedIndex + 1].x - playback[recordedIndex].x) * interpolation;
  const recordY = playback[recordedIndex].y + (playback[recordedIndex + 1].y - playback[recordedIndex].y) * interpolation;
  const recordR = playback[recordedIndex].r + (playback[recordedIndex + 1].r - playback[recordedIndex].r) * interpolation;
  ctx.translate(recordX + camOffsetX, recordY + camOffsetY);
  ctx.rotate(recordR * (Math.PI/180));
  ctx.drawImage(CAR_SPRITE, -car.width / 2, -car.height / 2, car.width, car.height);
  ctx.rotate(-recordR * (Math.PI/180));
  ctx.translate(-recordX - camOffsetX, -recordY - camOffsetY);
  //endregion

  //region Car
  ctx.translate(car.x + camOffsetX, car.y + camOffsetY);
  ctx.rotate(car.rotation * (Math.PI/180));
  ctx.drawImage(CAR_SPRITE, -car.width / 2, -car.height / 2, car.width, car.height);
  ctx.rotate(-car.rotation * (Math.PI/180));
  ctx.translate(-car.x - camOffsetX, -car.y - camOffsetY);
  //endregion

  //region HUD
  document.querySelector("#off-track").style.display = onTrack ? "none" : "block";

  //region Minitrack
  ctx.strokeStyle = "grey";
  ctx.lineWidth  = 10;
  ctx.beginPath();
  ctx.moveTo(TRACK[0][0] / miniTrackMul + MINI_TRACK_MARGIN_X, TRACK[0][1] / miniTrackMul + canvas.height - MINI_TRACK_SIZE - MINI_TRACK_MARGIN_Y);
  for (let point of TRACK) {
    ctx.lineTo(point[0] / miniTrackMul + MINI_TRACK_MARGIN_X, point[1] / miniTrackMul + canvas.height - MINI_TRACK_SIZE - MINI_TRACK_MARGIN_Y);
  }
  ctx.closePath();
  ctx.stroke();
  // position
  ctx.fillStyle = "red";
  ctx.beginPath();
  ctx.arc(TRACK[trackPos][0] / miniTrackMul + MINI_TRACK_MARGIN_X, TRACK[trackPos][1] / miniTrackMul + canvas.height - MINI_TRACK_SIZE - MINI_TRACK_MARGIN_Y, 5, 0, 2 * Math.PI);
  ctx.fill();
  //endregion

  //region Back to track
  ctx.strokeStyle = "red";
  ctx.beginPath();
  ctx.arc(canvas.width / 2, canvas.height / 2, 20, 0, 2 * Math.PI * (1 - (timeRemainingToTrack / BACK_TO_TRACK_TIME)));
  ctx.stroke();
  //endregion
  //endregion

  //region Debug
  if (DEBUG_MODE) {
    // Velocity
    ctx.lineWidth = 2;
    const mul = 100 / car.max_speed;
    // target
    ctx.strokeStyle = "blue";
    ctx.beginPath();
    ctx.moveTo(car.x + camOffsetX, car.y + camOffsetY);
    ctx.lineTo(car.x + car.xTargetVelocity * mul + camOffsetX, car.y + car.yTargetVelocity * mul + camOffsetY);
    ctx.stroke();
    // actual
    ctx.strokeStyle = "red";
    ctx.beginPath();
    ctx.moveTo(car.x + camOffsetX, car.y + camOffsetY);
    ctx.lineTo(car.x + car.xVelocity * mul + camOffsetX, car.y + car.yVelocity * mul + camOffsetY);
    ctx.stroke();
    // camera
    ctx.strokeStyle = "red";
    ctx.beginPath();
    ctx.arc(canvas.width / 2, canvas.height / 2, camera.range_radius, 0, 2 * Math.PI);
    ctx.stroke();
    ctx.strokeStyle = "green";
    ctx.beginPath();
    ctx.moveTo(canvas.width / 2, canvas.height / 2);
    ctx.lineTo(canvas.width / 2 + camVelocityX * 100, canvas.height / 2 + camVelocityY * 100);
    ctx.stroke();
    // distance to road
    ctx.strokeStyle = onTrack ? "green": "red";
    ctx.beginPath();
    ctx.arc(car.x + camOffsetX, car.y + camOffsetY, trackDis, 0, 2 * Math.PI);
    ctx.stroke();
  }
  //endregion
  //endregion
}, 0);

function startTimer() {
  startCountdown--;
  document.querySelector("#start-countdown").src = `./images/lights-${startCountdown}.png`;
  if (startCountdown <= 0) {
    car.running = true;
    setTimeout(() => {
      document.querySelector("#start-countdown").style.display = "none";
    }, 2000)

    const interval10 = setInterval(() => {
      if (isReturningToTrack && timeRemainingToTrack > 0) {
        timeRemainingToTrack -= 10;
        if (timeRemainingToTrack === 0) {
          const point = (trackPos - 5) % TRACK.length;
          returnToTrack(point);
        }
      } else {
        timeRemainingToTrack = BACK_TO_TRACK_TIME;
      }
      timer += 10;
      document.querySelector("#time").innerHTML = timerToText(timer);
    }, 10);

    const interval500 = setInterval(() => {
      const pos = laps * TRACK.length + trackPos;
      const normalizedPos = pos / (TRACK.length * TRACK_LAPS) * 100;
      if (normalizedPos >= 100) {
        clearInterval(interval10);
        clearInterval(interval500);
        car.running = false;
      }
      document.querySelector("#progression").style.width = `${normalizedPos}%`;

      // record
      recorded.push({
        x: car.x,
        y: car.y,
        r: car.rotation
      });
    }, 500);
  } else {
    setTimeout(startTimer, 1000);
  }
}
startTimer();

document.addEventListener("keydown", (e) => {
  if (e.code === "KeyA") {
    car.direction = -1;
  }
  if (e.code === "KeyD") {
    car.direction = 1;
  }
  if (e.code === "Space") {
    startCountdown = 1;
  }
  if (e.code === "KeyX") {
    isReturningToTrack = true;
  }
});

document.addEventListener("keyup", (e) => {
  if (e.code === "KeyA" || e.code === "KeyD") {
    car.direction = 0;
  }
  if (e.code === "KeyX") {
    isReturningToTrack = false;
  }
});